<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>4äººã‚µã‚¤ã‚³ãƒ­ã‚²ãƒ¼ãƒ  å®Œå…¨ç‰ˆï¼ˆåˆè¨ˆå€¤è¡¨ç¤ºæ©Ÿèƒ½ä»˜ãï¼‰</title>
<style>
  .money-particle {
  position: fixed;
  pointer-events: none;
  font-size: 40px;
  font-weight: 900;
  z-index: 9999;
  animation: floatUp 1.2s ease-out forwards;
  text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
}

@keyframes floatUp {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-120px); opacity: 0; }
}
:root{
  --bg:#7bd24a; --card:#fff; --muted:#666; --shadow:0 8px 20px rgba(0,0,0,0.18);
}
/* èƒŒæ™¯è‰²ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
body{height:100%;margin:0;font-family:"Helvetica Neue",Arial,sans-serif;transition: background 0.8s ease; transition: background 1s ease;}

.wrap{max-width:1100px;margin:0 auto;padding:18px;display:flex;flex-direction:column;min-height:100%;}
.players{display:flex;gap:10px;justify-content:space-between;margin-bottom:12px;}
.player{flex:1;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#f0f0f0);box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;transition:transform .18s;text-align:center; position: relative;}
.player.current{outline:4px solid rgba(0,0,0,0.06);transform:translateY(-6px);}

/* ã‚´ãƒ¼ãƒ«æ¸ˆã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.player.finished { opacity: 0.7; background: #ddd; }
.player.finished::after { content: "GOAL"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); font-size: 40px; font-weight: 800; color: rgba(255,0,0,0.3); border: 4px solid rgba(255,0,0,0.3); padding: 5px 20px; border-radius: 10px; pointer-events: none;}

.player .name{font-weight:800;margin-bottom:6px;}
.player .meta{font-size:13px;color:var(--muted);}
.player .buff{margin-top:8px;color:#b12727;font-weight:700;}
.player.lost{opacity:0.4;text-decoration:line-through;}
.p1{background:linear-gradient(180deg,#ff3131,#fff);}
.p2{background:linear-gradient(180deg,#38b6ff,#fff);}
.p3{background:linear-gradient(180deg,#7ed957,#fff);}
.p4{background:linear-gradient(180deg,#ffde59,#fff);}
.main-grid{display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start;}
.board{display:flex;flex-direction:column;align-items:center;padding:12px;}
.dice-box{width:260px;height:160px;border-radius:14px;background:var(--card);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;position:relative;}
.dice-images{display:flex;gap:10px;align-items:center;justify-content:center;}
.dice-images img{width:80px;height:80px;object-fit:contain;transition:transform .45s ease;}
.controls{display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap;justify-content:center;}

/* === è¿½åŠ ã•ã‚ŒãŸã‚¹ã‚¿ã‚¤ãƒ« === */
#dice-sum {
  margin-top: 10px;
  font-size: 28px;
  font-weight: 900;
  color: #333;
  padding: 5px 15px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.7);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
/* ======================== */

.icon-btn{width:44px;height:44px;border-radius:8px;border:0;background:#f3f3f3;font-size:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.big-btn{height:48px;padding:0 20px;border-radius:12px;border:0;background:#fff;font-weight:800;box-shadow:var(--shadow);cursor:pointer;}

/* ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
button:disabled {
  background: #ccc !important;
  color: #888 !important;
  cursor: not-allowed !important;
  transform: none !important;
  box-shadow: none !important;
}

/* ãƒœã‚¿ãƒ³ã®è‰²åˆ†ã‘ */
.shop-btn{background:#9c27b0; color:#fff;} 
.goal-btn{background:#ff9800; color:#fff;}
.finish-btn{background:#f44336; color:#fff;}

.event-card{border-radius:12px;background:linear-gradient(180deg,#fff8d9,#fff);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;padding:14px;font-size:16px;color:#222;transition:transform .25s,opacity .25s;}
.event-card.hidden{opacity:0;transform:translateY(12px);pointer-events:none;}
.event-label{font-weight:800;margin-right:10px;color:#b27b00;}
.event-sub{font-size:14px;color:var(--muted);}
.money-panel{background:linear-gradient(180deg,#fff,#f7f7f7);border-radius:12px;padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px;}
.person-money{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;}
.name-input{border-radius:8px;border:1px solid #ddd;padding:6px 8px;font-weight:700;}
.total{font-size:18px;font-weight:800;margin-top:6px;}
.color-bar{width:14px;height:48px;border-radius:6px;margin-right:6px;}
.money-buttons{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;}
.money-buttons button{padding:4px 8px;border-radius:6px;border:0;background:#f0f0f0;font-weight:700;cursor:pointer;transition:0.2s;}
.money-buttons button:hover{background:#ddd;}
#quiz-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:999;}
#quiz-box{background:#fff;padding:24px;border-radius:16px;max-width:600px;width:90%;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.3);}
#quiz-box h2{margin-bottom:16px;font-size:20px;}
#quiz-options{display:flex;flex-direction:column;gap:10px;margin-top:12px;}
#quiz-options button{padding:12px;border-radius:10px;border:0;background:#f0f0f0;font-weight:700;cursor:pointer;transition:0.2s;}
#quiz-options button:hover{background:#ddd;}
#quiz-result{margin-top:16px;font-weight:800;font-size:18px;}
#quiz-ok{margin-top:16px;padding:10px 20px;border-radius:12px;border:0;background:#4CAF50;color:#fff;font-weight:800;cursor:pointer;display:none;}
#winner-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:1000;}
#winner-box{background:#fff;padding:32px;border-radius:16px;max-width:500px;width:90%;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.3);}
#winner-box h2{font-size:28px;margin-bottom:16px;}
#winner-box button{padding:12px 20px;border-radius:12px;border:0;background:#4CAF50;color:#fff;font-weight:800;cursor:pointer;}

/* ã‚·ãƒ§ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨CSS */
#shop-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:999;}
#shop-box{background:#fff;padding:24px;border-radius:16px;max-width:600px;width:90%;box-shadow:0 8px 20px rgba(0,0,0,0.3);}
#shop-box h2{margin-bottom:16px;font-size:20px; text-align:center; color:#9c27b0;}
.shop-list{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
.shop-item{border:2px solid #eee; border-radius:10px; padding:10px; display:flex; flex-direction:column; align-items:center; text-align:center;}
.shop-item h3{margin:5px 0; font-size:16px;}
.shop-item p{font-size:12px; color:#666; height:30px;}
.shop-price{font-weight:800; color:#e91e63; margin-bottom:8px;}
.shop-buy-btn{padding:8px 16px; border-radius:8px; border:none; background:#9c27b0; color:#fff; font-weight:700; cursor:pointer;}
.shop-buy-btn:disabled{background:#ccc; cursor:not-allowed;}
#shop-close{margin-top:16px; width:100%; padding:10px; border-radius:10px; border:none; background:#666; color:#fff; font-weight:700; cursor:pointer;}
.target-btn{background:#e91e63; margin-top:5px; padding:10px; border-radius:8px; border:none; color:#fff; font-weight:700; cursor:pointer; width:100%;}

/* ä¸‡èƒ½è–¬å›å¾©ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
#recovery-modal {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:1001;}
#recovery-box {background:#fff;padding:24px;border-radius:16px;max-width:400px;width:90%;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.3);}
#recovery-box h2 {color:#e91e63; margin-bottom:12px;}
#recovery-text {margin-bottom:20px; font-weight:bold;}
.recovery-actions {display:flex; gap:10px; justify-content:center;}
.rec-btn {padding:10px 20px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; color:#fff;}
.rec-yes {background:#4CAF50;}
.rec-no {background:#f44336;}

body{height:100%;margin:0;font-family:"Helvetica Neue",Arial,sans-serif;}
/* çµŒæ¸ˆçŠ¶æ³è¡¨ç¤ºãƒ‘ãƒãƒ« */
#economy-panel {
  background: rgba(255,255,255,0.9);
  padding: 8px 16px;
  border-radius: 20px;
  margin-bottom: 10px;
  text-align: center;
  font-weight: bold;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  border: 2px solid #333;
  transition: background 0.5s ease;
  border: 3px solid #333;
}
#economy-icon { font-size: 24px; }

/* èª¤ä½œå‹•å¯¾ç­–ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆä½ç½®ã‚’ã‚¿ãƒ¼ãƒ³çµ‚äº†ã®ä¸‹ã¸å¤‰æ›´ï¼‰ */
.system-controls {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 20px;
  width: 100%;
}
.sys-btn {
  background: #555; 
  color: #fff; 
  border: 1px solid rgba(255,255,255,0.2);
  padding: 8px 12px; 
  border-radius: 8px; 
  cursor: pointer; 
  font-size: 12px; 
  text-decoration: none;
  font-weight: bold;
  box-shadow: 0 4px 6px rgba(0,0,0,0.2);
  transition: 0.2s;
}
.sys-btn:hover { background: #333; transform: translateY(-2px); }
.sys-btn:active { transform: translateY(0); }
</style>
</head>
<body>
<div class="wrap">

  <div id="economy-panel">
    <span id="economy-icon">â˜€ï¸</span>
    <span id="economy-text">çµŒæ¸ˆçŠ¶æ³: å¹³ç©</span>
  </div>

<div class="players" id="players">
  <div class="player p1 current" id="pl-1"><div class="name" id="plname-0">Player 1</div><div class="meta">è‰²: èµ¤</div><div class="buff" id="buff-1"></div></div>
  <div class="player p2" id="pl-2"><div class="name" id="plname-1">Player 2</div><div class="meta">è‰²: é’</div><div class="buff" id="buff-2"></div></div>
  <div class="player p3" id="pl-3"><div class="name" id="plname-2">Player 3</div><div class="meta">è‰²: ç·‘</div><div class="buff" id="buff-3"></div></div>
  <div class="player p4" id="pl-4"><div class="name" id="plname-3">Player 4</div><div class="meta">è‰²: é»„</div><div class="buff" id="buff-4"></div></div>
</div>

<div class="main-grid">
  <section class="board">
    <div class="dice-box" aria-live="polite">
      <div class="dice-images" id="dice-area"></div>
    </div>
    
    <div id="dice-sum">åˆè¨ˆ: 0</div>
    <div style="margin-top:10px">ç¾åœ¨ã®ç•ª: <strong id="turn-name">Player 1</strong></div>
    
    <div class="controls" style="margin-top:12px">
      <button class="big-btn" id="rollBtn">ğŸ² ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
      <button class="big-btn" id="eventBtn">âš¡ ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹</button>
      <button class="big-btn shop-btn" id="shopBtn">ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—</button>
    </div>
    
    <div class="controls" style="margin-top:10px;">
        <button class="big-btn goal-btn" id="goalBtn">ğŸš© 1ã¤ã‚´ãƒ¼ãƒ« (+4000)</button>
        <button class="big-btn finish-btn" id="finishBtn">ğŸ‘‘ ä¸ŠãŒã‚Šï¼ (é †ä½ç¢ºå®š)</button>
    </div>

    <div style="width:100%;max-width:520px;margin-top:14px">
      <div class="event-card hidden" id="event-card" role="status" aria-live="polite">
        <div>
          <div class="event-label" id="event-label">ã‚¤ãƒ™ãƒ³ãƒˆ</div>
          <div class="event-sub" id="event-text">ã“ã“ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
      </div>
    </div>
    <div style="margin-top:12px">
      <button class="big-btn" id="endBtn">ã‚¿ãƒ¼ãƒ³çµ‚äº† â†’ æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸</button>
    </div>

    <div class="system-controls">
      <button class="sys-btn" id="undoBtn">â†©ï¸ ã²ã¨ã¤æˆ»ã‚‹</button>
      <button class="sys-btn" id="redoBtn">â†ªï¸ ã²ã¨ã¤é€²ã‚€</button>
      <a href="index.html" class="sys-btn">ğŸ  ã‚¿ã‚¤ãƒˆãƒ«ã¸</a>
    </div>

  </section>

  <aside class="money-panel"></aside>
</div>

<div id="recovery-modal">
  <div id="recovery-box">
    <h2>ğŸ’Š å›å¾©ç¢ºèª</h2>
    <p id="recovery-text">ä¸‡èƒ½è–¬ ($300) ã‚’è³¼å…¥ã—ã¦ã€<br>çŠ¶æ…‹ç•°å¸¸ã‚’å›å¾©ã—ã¾ã™ã‹ï¼Ÿ</p>
    <div class="recovery-actions">
      <button class="rec-btn rec-yes" id="rec-yes-btn">ã¯ã„ ($300æ‰•ã†)</button>
      <button class="rec-btn rec-no" id="rec-no-btn">ã„ã„ãˆ (ã‚¹ã‚­ãƒƒãƒ—)</button>
    </div>
  </div>
</div>

<div id="dice-six-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:9999;">
  <div style="background:#fff;padding:30px;border-radius:20px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.5);max-width:400px;width:90%;">
    <h2 style="color:#d32f2f;margin-top:0;">ğŸ² 6ãŒå‡ºã¾ã—ãŸï¼</h2>
    <p style="font-weight:bold;margin-bottom:20px; color:#333;">ã©ã¡ã‚‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ</p>
    <div style="display:flex;flex-direction:column;gap:15px;">
      <button id="choice-reroll" style="padding:15px;font-size:18px;font-weight:bold;background:#4CAF50;color:#fff;border:none;border-radius:12px;cursor:pointer;">ã‚‚ã†ä¸€åº¦ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
      <button id="choice-spawn" style="padding:15px;font-size:18px;font-weight:bold;background:#2196F3;color:#fff;border:none;border-radius:12px;cursor:pointer;">æ–°ã—ã„ã‚³ãƒã‚’å‡ºã™(å‡ºåº«)</button>
    </div>
  </div>
</div>

<div id="shop-modal">
  <div id="shop-box">
    <h2 id="shop-title">ã‚¢ã‚¤ãƒ†ãƒ ã‚·ãƒ§ãƒƒãƒ—</h2>
    <div class="shop-list" id="shop-list"></div>
    <button id="shop-close">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="quiz-modal">
  <div id="quiz-box">
    <h2 id="quiz-question">å•é¡Œ</h2>
    <div id="quiz-options"></div>
    <div id="quiz-result"></div>
    <button id="quiz-ok">OK</button>
  </div>
</div>

<div id="winner-modal">
  <div id="winner-box">
    <h2 id="winner-text">ã€‡ã€‡ win!!</h2>
    <button id="restart-btn">æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸</button>
  </div>
</div>

<div id="lottery-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:1100;color:#fff;">
  <div style="background:#222;padding:30px;border-radius:20px;text-align:center;border:4px solid #ffd700;max-width:400px;width:90%;">
    <h2 style="color:#ffd700;margin-bottom:20px;">ğŸ° å®ãã˜ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ ğŸ°</h2>
    <div id="roulette-display" style="font-size:48px;font-weight:900;margin:30px 0;color:#fff;text-shadow:0 0 10px #ffd700;height:60px;">$0</div>
    <button id="lottery-stop-btn" class="big-btn" style="background:#ffd700;color:#000;width:100%;font-size:20px;">STOP!</button>
    <button id="lottery-ok-btn" class="big-btn" style="background:#4CAF50;color:#fff;width:100%;font-size:20px;display:none;">è³é‡‘ã‚’å—ã‘å–ã‚‹</button>
  </div>
</div>

<div id="dice-selection-modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center;z-index:1005;">
  <div style="background:#fff;padding:24px;border-radius:16px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.3);">
    <h2>é€²ã‚€æ•°ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
    <div id="dice-selection-btns" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:15px;">
      </div>
    <button onclick="document.getElementById('dice-selection-modal').style.display='none'" style="margin-top:15px;padding:8px;border:none;background:#666;color:#fff;border-radius:8px;cursor:pointer;width:100%;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

</div>

<script>
  function openDiceSelection(player) {
  const modal = document.getElementById('dice-selection-modal');
  const container = document.getElementById('dice-selection-btns');
  container.innerHTML = '';
  modal.style.display = 'flex';

  // 1ã‹ã‚‰6ã¾ã§ã®ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
  for (let i = 1; i <= 6; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.style.cssText = "padding:15px;font-size:20px;font-weight:bold;border-radius:10px;border:none;background:#38b6ff;color:#fff;cursor:pointer;";
    
    btn.onclick = () => {
      saveState();
      modal.style.display = 'none';
      shopModal.style.display = 'none'; // ã‚·ãƒ§ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
      
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç§»å‹•ã•ã›ã‚‹
      player.pos += i;
      showEventCard(`${player.name}ã¯è‡ªåœ¨ã‚«ãƒ¼ãƒ‰ã§ ${i} ãƒã‚¹é€²ã‚“ã ï¼`);
      
      // ç§»å‹•å¾Œã®UIæ›´æ–°
      updateUI();
      
      // ã‚‚ã—ç§»å‹•å¾Œã®å‡¦ç†ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿãªã©ï¼‰ã‚’è‡ªå‹•ã§è¡Œã„ãŸã„å ´åˆã¯ã“ã“ã«è¿½è¨˜
    };
    container.appendChild(btn);
  }
}
  function spawnMoneyParticle(amount) {
  const el = document.createElement('div');
  el.className = 'money-particle';
  
  if (amount > 0) {
    el.textContent = `+$${amount}`;
    el.style.color = '#4eff4e'; 
  } else if (amount < 0) {
    el.textContent = `-$${Math.abs(amount)}`;
    el.style.color = '#ff4e4e';
  } else {
    return;
  }

  el.style.left = (window.innerWidth / 2 - 50) + 'px';
  el.style.top = (window.innerHeight / 2) + 'px';

  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1200);
}
// --- å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆUndo/Redoï¼‰ ---
let historyStack = [];
let redoStack = [];

// çŠ¶æ…‹ä¿å­˜ï¼ˆæ“ä½œã®ç›´å‰ã«å‘¼ã¶ï¼‰
function saveState() {
  if(historyStack.length > 20) historyStack.shift(); 
  const state = {
    players: JSON.parse(JSON.stringify(players)),
    currentPlayer: currentPlayer,
    economyMode: economyMode,
    rankCounter: rankCounter,
    isExtraRoll: isExtraRoll,
    rollDisabled: rollBtn.disabled,
    eventDisabled: eventBtn.disabled
  };
  historyStack.push(state);
  redoStack = []; 
}

// çŠ¶æ…‹å¾©å…ƒ
function restoreState(state) {
  players.forEach((p, i) => {
    Object.assign(p, state.players[i]);
  });
  
  currentPlayer = state.currentPlayer;
  economyMode = state.economyMode;
  rankCounter = state.rankCounter;
  isExtraRoll = state.isExtraRoll;
  
  rollBtn.disabled = state.rollDisabled;
  eventBtn.disabled = state.eventDisabled;
  
  updateEconomyDisplay();
  updateUI();
}

document.getElementById('undoBtn').addEventListener('click', () => {
  if (historyStack.length > 0) {
    const currentState = {
        players: JSON.parse(JSON.stringify(players)),
        currentPlayer: currentPlayer,
        economyMode: economyMode,
        rankCounter: rankCounter,
        isExtraRoll: isExtraRoll,
        rollDisabled: rollBtn.disabled,
        eventDisabled: eventBtn.disabled
    };
    redoStack.push(currentState);
    
    const prevState = historyStack.pop();
    restoreState(prevState);
    showEventCard("â†©ï¸ ã²ã¨ã¤å‰ã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸ");
  } else {
    showEventCard("ã“ã‚Œä»¥ä¸Šæˆ»ã‚Œã¾ã›ã‚“");
  }
});

document.getElementById('redoBtn').addEventListener('click', () => {
  if (redoStack.length > 0) {
    const currentState = {
        players: JSON.parse(JSON.stringify(players)),
        currentPlayer: currentPlayer,
        economyMode: economyMode,
        rankCounter: rankCounter,
        isExtraRoll: isExtraRoll,
        rollDisabled: rollBtn.disabled,
        eventDisabled: eventBtn.disabled
    };
    historyStack.push(currentState);

    const nextState = redoStack.pop();
    restoreState(nextState);
    showEventCard("â†ªï¸ ã²ã¨ã¤é€²ã¿ã¾ã—ãŸ");
  } else {
    showEventCard("ã“ã‚Œä»¥ä¸Šé€²ã‚ã¾ã›ã‚“");
  }
});

// --- æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ ---

let isExtraRoll = false;
let economyMode = 'normal'; 
let rankCounter = 1; 
const rankBonuses = [0, 10000, 8000, 5000, 2000];

let diceCount = 1;
let currentPlayer = 0;
const players = [
  {name:"Player 1", total:1000, buff:0, skipTurn:0, reverse:0, pos:0, color:"#ff5858", lost:false, finished:false, rank:0,color:"#ffb3b3"},
  {name:"Player 2", total:1000, buff:0, skipTurn:0, reverse:0, pos:0, color:"#4da6ff", lost:false, finished:false, rank:0,color:"#b3d1ff"},
  {name:"Player 3", total:1000, buff:0, skipTurn:0, reverse:0, pos:0, color:"#7df07e", lost:false, finished:false, rank:0,color:"#b3ffb3"},
  {name:"Player 4", total:1000, buff:0, skipTurn:0, reverse:0, pos:0, color:"#ffd86b", lost:false, finished:false, rank:0,color:"#ffffb3"}
];

// --- ã‚¯ã‚¤ã‚ºã®ç™ºç”Ÿç¢ºç‡ã‚’ç´„10%ã«ã™ã‚‹ãŸã‚ã€"ã‚¯ã‚¤ã‚ºï¼"ã‚’3ã¤ã«å¢—ã‚„ã—ã¾ã—ãŸ ---
const events = [
  "ã‚‚ã†ä¸€åº¦ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦å‡ºãŸç›®åˆ†æˆ»ã‚‹","ã‚‚ã†ä¸€åº¦ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦å‡ºãŸç›®åˆ†é€²ã‚€","æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‚µã‚¤ã‚³ãƒ­1ã¤è¿½åŠ ",
  "å…¨éƒ¨ã®ã‚³ãƒã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹","ã‚³ãƒã‚’ï¼‘ã¤ã‚´ãƒ¼ãƒ«ã«é€²ã‚ã‚‹","æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã€é€²ã‚€ãƒã‚¹Ã—ï¼’",
  "ã‚‚ã†ä¸€å›è¡Œå‹•ã§ãã‚‹","1ã‚¿ãƒ¼ãƒ³ä¼‘ã¿","æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã ã‘ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒå›é¿",
  "å¼·å¥ª(æ¬¡ã®ç•ªã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰$800ã‚‚ã‚‰ãˆã‚‹)","ä¸€äº¤æ›(å³éš£ã®äººã¨ã‚³ãƒã®å ´æ‰€äº¤æ›)","3ã‚¿ãƒ¼ãƒ³é€†èµ°",
  "æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‚µã‚¤ã‚³ãƒ­3ã¤è¿½åŠ ","æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‚µã‚¤ã‚³ãƒ­2ã¤è¿½åŠ ",
  "ä¼šç¤¾ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæˆåŠŸã—ã€è‡¨æ™‚ãƒœãƒ¼ãƒŠã‚¹ãŒå‡ºãŸã€$1000ç²å¾—","ä¸‡å¼•ãæˆåŠŸ$5000ç²å¾—","ãŠé‡‘ã‚’æ‹¾ã£ãŸ$800ç²å¾—","$ãƒ•ãƒªãƒã‚¢ãƒ—ãƒªã§é«˜ãå£²ã‚ŒãŸ$3000ç²å¾—","æ‹äººãŒã§ããŸ$500ç²å¾—","ã”ç¥å„€ã‚’ã‚‚ã‚‰ã£ãŸ$900ç²å¾—","ä»®æƒ³é€šè²¨ã§å¤§å½“ãŸã‚Š$7000ç²å¾—",
  "ç«¶é¦¬ã«è² ã‘ãŸ$800å¤±ã†","ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ä¸æ­£åˆ©ç”¨$1000å¤±ã†","ã‚¯ãƒ¼ãƒªãƒ³ã‚°ã‚ªãƒ•ã«å¤±æ•—$500å¤±ã†","ç‰çªãäº‹æ•…è¶³æŠ˜ã‚ŒãŸ$900å¤±ã†","è©æ¬ºãƒ¡ãƒ¼ãƒ«ã«å¼•ã£ã‹ã‹ã‚‹$200å¤±ã†","æ ªå¤±æ•—$8000å¤±ã†","ã‚´ãƒ¼ãƒ«ã®ã‚³ãƒå¤±ã†",
  "ã‚¯ã‚¤ã‚ºï¼","ã‚¯ã‚¤ã‚ºï¼","ã‚¯ã‚¤ã‚ºï¼","å®ãã˜","å®ãã˜","å®ãã˜","å®ãã˜" // 10% (3/30) ã®ç¢ºç‡ã§ç™ºç”Ÿ
];
// ------------------------------------------------------------------------------------------

let lotteryInterval;
let currentLotteryAmount = 0;
const lotteryValues = [0, 100, 300, 500, 1000, 2000, 3000, 5000, 10000];

function startLottery(pIdx) {
  const modal = document.getElementById('lottery-modal');
  const display = document.getElementById('roulette-display');
  const stopBtn = document.getElementById('lottery-stop-btn');
  const okBtn = document.getElementById('lottery-ok-btn');
  
  modal.style.display = 'flex';
  stopBtn.style.display = 'block';
  okBtn.style.display = 'none';
  display.style.color = "#ffd700"; // åˆæœŸã®è‰²

  // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  lotteryInterval = setInterval(() => {
    currentLotteryAmount = lotteryValues[Math.floor(Math.random() * lotteryValues.length)];
    display.textContent = `$${currentLotteryAmount}`;
  }, 50);

  stopBtn.onclick = () => {
    clearInterval(lotteryInterval);
    stopBtn.style.display = 'none';
    okBtn.style.display = 'block';
    display.style.color = "#fff"; // ç¢ºå®šæ™‚ã®è‰²
    display.textContent = `å½“é¸ï¼ $${currentLotteryAmount}`;
  };

  okBtn.onclick = () => {
    saveState(); // å±¥æ­´ã«ä¿å­˜
    
    let finalAmount = currentLotteryAmount;
    
    // 1. çµŒæ¸ˆçŠ¶æ³ï¼ˆã‚¤ãƒ³ãƒ•ãƒ¬ãƒ»ãƒ‡ãƒ•ãƒ¬ï¼‰ã‚’åæ˜ ã•ã›ã‚‹
    if(economyMode === 'inflation') finalAmount *= 2;
    if(economyMode === 'deflation') finalAmount = Math.floor(finalAmount / 2);
    
    // 2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰€æŒé‡‘ã‚’å¢—ã‚„ã™
    players[pIdx].total += finalAmount;

    // â˜… 3. ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆæµ®ãä¸ŠãŒã‚‹æ•°å­—ï¼‰ã‚’è¡¨ç¤º
    if (finalAmount > 0) {
      spawnMoneyParticle(finalAmount); 
    }
    
    // 4. UIã‚’æ›´æ–°ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    updateUI();
    modal.style.display = 'none';
    
    // 5. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    showEventCard(`${players[pIdx].name}ã¯å®ãã˜ã§$${finalAmount}ç²å¾—ï¼`);
    
    // 6. ãƒœã‚¿ãƒ³åˆ¶å¾¡
    rollBtn.disabled = true;
    eventBtn.disabled = true;
  };
}

const quizzes=[
  {q:"ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦ã§æ—¥æœ¬ãŒé™ä¼ã—ãŸå¹´ã¯ï¼Ÿ", options:["1944","1945","1946","1947"], answer:1},
  {q:"ãƒ•ãƒ©ãƒ³ã‚¹é©å‘½ãŒå§‹ã¾ã£ãŸå¹´ã¯ï¼Ÿ", options:["1788","1789","1790","1791"], answer:1},
  {q:"æ—¥æœ¬å›½æ†²æ³•ã®æ–½è¡Œæ—¥ã¯ï¼Ÿ", options:["1945å¹´5æœˆ3æ—¥","1946å¹´5æœˆ3æ—¥","1947å¹´5æœˆ3æ—¥","1948å¹´5æœˆ3æ—¥"], answer:2},
  {q:"å…ƒç´  Feï¼ˆé‰„ï¼‰ã®é…¸åŒ–çŠ¶æ…‹ã§æœ€ã‚‚å®‰å®šã—ã¦ã„ã‚‹ã‚‚ã®ã¯ï¼Ÿ", options:["+1","+2","+3","+4"], answer:2},
  {q:"é«˜æ ¡ç”Ÿç‰©ã§ã€éºä¼æƒ…å ±ã‚’æ‹…ã†ç‰©è³ªã¯ï¼Ÿ", options:["ã‚¿ãƒ³ãƒ‘ã‚¯è³ª","RNA","DNA","è„‚è³ª"], answer:2},
  {q:"é…¸åŒ–é‚„å…ƒåå¿œã§é›»å­ã‚’å¤±ã†ã‚‚ã®ã¯ï¼Ÿ", options:["é…¸åŒ–å‰¤","é‚„å…ƒå‰¤","æ°´","é…¸ç´ "], answer:1},
  {q:"ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ³ã®æ³•å‰‡ã§ã€ç‰©ä½“ã«åŠ›ãŒåŠ ã‚ã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿ", options:["é€Ÿåº¦ãŒå¤‰ã‚ã‚‹","ä½ç½®ãŒå¤‰ã‚ã‚‹ã ã‘","è³ªé‡ãŒå¤‰ã‚ã‚‹","åŠ é€Ÿåº¦ã¯ä¸€å®š"], answer:0},
  {q:"sin30Â°ã®å€¤ã¯ï¼Ÿ", options:["1/2","âˆš2/2","âˆš3/2","1"], answer:0},
  {q:"å…‰ã®å±ˆæŠ˜ã§å…‰ãŒåª’è³ªã«å…¥ã‚‹ã¨ãé€Ÿåº¦ã¯ã©ã†ãªã‚‹ï¼Ÿ", options:["é€Ÿããªã‚‹","é…ããªã‚‹","å¤‰ã‚ã‚‰ãªã„","é€†æ–¹å‘ã«æ›²ãŒã‚‹"], answer:1},
  {q:"è‘‰ç·‘ä½“ã§èµ·ã“ã‚‹åå¿œã¯ï¼Ÿ", options:["å‘¼å¸","å…‰åˆæˆ","ç™ºé…µ","åˆ†è§£"], answer:1},
  {q:"DNAè¤‡è£½ã¯ç´°èƒå‘¨æœŸã®ã©ã®æ®µéšã§è¡Œã‚ã‚Œã‚‹ï¼Ÿ", options:["åˆ†è£‚æœŸ","é–“æœŸ","å‰æœŸ","å¾ŒæœŸ"], answer:1},
  {q:"æ—¥æœ¬ã®ä¸‰æ¨©åˆ†ç«‹ã®è¡Œæ”¿æ¨©ã‚’æ‹…ã†ã®ã¯ï¼Ÿ", options:["å›½ä¼š","å†…é–£","è£åˆ¤æ‰€","åœ°æ–¹è‡ªæ²»ä½“"], answer:1},
  {q:"æ—¥æœ¬ã®å›½ä¼šã¯è¡†è­°é™¢ã¨ä½•ã§æ§‹æˆã•ã‚Œã‚‹ï¼Ÿ", options:["å‚è­°é™¢","ä¸Šé™¢","ä¸‹é™¢","å›½å‹™é™¢"], answer:0},
  {q:"ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦å¾Œã€å›½éš›é€£åˆãŒè¨­ç«‹ã•ã‚ŒãŸå¹´ã¯ï¼Ÿ", options:["1944","1945","1946","1947"], answer:1},
  {q:"å…‰ã®åå°„ã§å…¥å°„è§’=åå°„è§’ã®æ³•å‰‡ã‚’ç™ºè¦‹ã—ãŸäººç‰©ã¯ï¼Ÿ", options:["ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ³","ã‚¹ãƒãƒ«","ãƒ•ãƒƒã‚¯","ã‚¢ã‚¤ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³"], answer:1},
  {q:"If I ___ you, I would have apologized earlier.", options:["am","was","were","be"], answer:2},
  {q:"Choose the correct sentence.", options:["Hardly I had arrived when it started raining.","Hardly had I arrived when it started raining.","I had hardly arrived when it started raining.","Hardly had I arrived it started raining."], answer:1},
  {q:"He insisted on ___ early.", options:["to leave","leaving","leave","leaved"], answer:1},
  {q:"The book, ___ was on the table, disappeared.", options:["who","whom","which","whose"], answer:2},
  {q:"No sooner ___ the train than it started raining.", options:["did he leave","he left","had he left","he had left"], answer:2},
  {q:"I wish I ___ studied harder for the exam.", options:["have","had","had had","would have"], answer:2},
  {q:"Rarely ___ such a beautiful sunset.", options:["I have seen","have I seen","I saw","I had seen"], answer:1},
  {q:"She made him ___ the report immediately.", options:["finish","finished","to finish","finishing"], answer:0},
  {q:"If it ___ for your help, I couldn't have completed it.", options:["wasn't","weren't","hadn't been","isn't"], answer:2},
  {q:"He has been working here ___ five years.", options:["since","for","from","during"], answer:1},
  {q:"ã‚¢ãƒ¡ãƒªã‚«ç‹¬ç«‹å®£è¨€ã¯ä½•å¹´ã«æ¡æŠã•ã‚ŒãŸï¼Ÿ", options:["1775","1776","1777","1778"], answer:1},
  {q:"ãƒ•ãƒ©ãƒ³ã‚¹é©å‘½ã§æ¨©åŠ›ã‚’æ¡ã£ãŸäººç‰©ã¯ï¼Ÿ", options:["ãƒ«ã‚¤16ä¸–","ãƒŠãƒãƒ¬ã‚ªãƒ³","ãƒ­ãƒ™ã‚¹ãƒ”ã‚¨ãƒ¼ãƒ«","ãƒ«ã‚¤14ä¸–"], answer:2},
  {q:"ã‚¤ã‚®ãƒªã‚¹ã§ç”£æ¥­é©å‘½ãŒæœ€åˆã«å§‹ã¾ã£ãŸåˆ†é‡ã¯ï¼Ÿ", options:["ç¹Šç¶­ç”£æ¥­","é‰„é‹¼æ¥­","é€ èˆ¹æ¥­","è¾²æ¥­"], answer:0},
  {q:"å…ƒç´  Oï¼ˆé…¸ç´ ï¼‰ã¯å‘¨æœŸè¡¨ã®ä½•æ—ï¼Ÿ", options:["ãƒãƒ­ã‚²ãƒ³","å¸Œã‚¬ã‚¹","é…¸ç´ æ—","ã‚¢ãƒ«ã‚«ãƒªé‡‘å±"], answer:2},
  {q:"æ—¥æœ¬ã®æœ€é«˜è£åˆ¤æ‰€ã¯ã©ã®æ¨©åŠ›ã«å±ã™ã‚‹ï¼Ÿ", options:["ç«‹æ³•","è¡Œæ”¿","å¸æ³•","æ¤œå¯Ÿ"], answer:2},
  {q:"é«˜æ ¡ç‰©ç†ã§ã€å…‰ã¯çœŸç©ºä¸­ã§ä½•m/sã§ä¼ã‚ã‚‹ï¼Ÿ", options:["3Ã—10â¶","3Ã—10â¸","3Ã—10Â¹â°","3Ã—10Â¹Â²"], answer:1},
  {q:"é«˜æ ¡åŒ–å­¦ã§ã€æ°´é…¸åŒ–ãƒŠãƒˆãƒªã‚¦ãƒ  NaOH ã¯ä½•æ€§ï¼Ÿ", options:["é…¸æ€§","å¡©åŸºæ€§","ä¸­æ€§","é…¸åŒ–æ€§"], answer:1},
  {q:"é«˜æ ¡åœ°ç†ã§ã€æ—¥æœ¬ã®åŒ—æµ·é“åœ°æ–¹ã®æ°—å€™ã¯ï¼Ÿ", options:["äºœå¯’å¸¯æ¹¿æ½¤æ°—å€™","æ¸©æš–æ¹¿æ½¤æ°—å€™","åœ°ä¸­æµ·æ€§æ°—å€™","ç ‚æ¼ æ°—å€™"], answer:0},
  {q:"ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦å¾Œã€å†·æˆ¦ãŒå§‹ã¾ã£ãŸç†ç”±ã¯ï¼Ÿ", options:["è³‡æºäº‰å¥ª","ã‚¤ãƒ‡ã‚ªãƒ­ã‚®ãƒ¼å¯¾ç«‹","æ¤æ°‘åœ°ç²å¾—","å®—æ•™å¯¾ç«‹"], answer:1}
];

const countEl=document.getElementById('count'); 
const diceAreaEl=document.getElementById('dice-area');
const diceSumEl=document.getElementById('dice-sum'); // === è¿½åŠ  ===
const rollBtn=document.getElementById('rollBtn');
const eventBtn=document.getElementById('eventBtn');
const goalBtn=document.getElementById('goalBtn');
const finishBtn=document.getElementById('finishBtn');
const endBtn=document.getElementById('endBtn');
const eventCard=document.getElementById('event-card');
const eventText=document.getElementById('event-text');
const eventLabel=document.getElementById('event-label');
const turnName=document.getElementById('turn-name');

const quizModal=document.getElementById('quiz-modal');
const quizQuestion=document.getElementById('quiz-question');
const quizOptions=document.getElementById('quiz-options');
const quizResult=document.getElementById('quiz-result');
const quizOk=document.getElementById('quiz-ok');

const winnerModal=document.getElementById('winner-modal');
const winnerText=document.getElementById('winner-text');
const restartBtn=document.getElementById('restart-btn');

function updateUI(){
  for(let i=0;i<players.length;i++){
    const el=document.getElementById('pl-'+(i+1));
    el.classList.remove('lost', 'current', 'finished');
    if(players[i].lost) el.classList.add('lost');
    if(players[i].finished) el.classList.add('finished');
    if(i===currentPlayer) el.classList.add('current');
    
    let buffs=[];
    if(players[i].finished) {
       buffs.push(`ğŸ† ${players[i].rank}ä½ã§ã‚´ãƒ¼ãƒ«ï¼`);
    } else {
       if(players[i].buff>0) buffs.push(`ğŸ² +${players[i].buff}`);
       if(players[i].reverse>0) buffs.push(`ğŸ”„${players[i].reverse}ã‚¿ãƒ¼ãƒ³é€†èµ°`);
       if(players[i].skipTurn>0) buffs.push(`â¸${players[i].skipTurn}ã‚¿ãƒ¼ãƒ³ä¼‘ã¿`);
    }
    
    document.getElementById('buff-'+(i+1)).textContent=buffs.join(" / ");
    document.getElementById('plname-'+i).textContent=players[i].name;
    const totEl=document.getElementById('total-'+i);
    if(totEl) totEl.textContent=players[i].total;
    if(players[i].total <=0 && !players[i].lost){
      players[i].lost=true;
      showEventCard(`${players[i].name} ã¯æ‰€æŒé‡‘0ã§å¤±æ ¼ã«ãªã‚Šã¾ã—ãŸï¼`);
    }
  }
  turnName.textContent=players[currentPlayer].name;
  document.body.style.backgroundColor = players[currentPlayer].color;
  checkWinner();
}

function checkWinner(){
  const active = players.filter(p=> !p.lost && !p.finished);
  const survivors = players.filter(p => !p.lost);
  
  if(active.length === 0 || (survivors.length === 1 && survivors[0].finished)){
     let maxMoney = -999999;
     let winner = null;
     players.forEach(p => {
       if(!p.lost && p.total > maxMoney){
         maxMoney = p.total;
         winner = p;
       }
     });
     if(winner){
       winnerText.textContent = `è³‡ç”£ç‹: ${winner.name} ($${winner.total})`;
       winnerModal.style.display='flex';
     }
  }
}

restartBtn.addEventListener('click',()=>{
  saveState(); 
  players.forEach(p=>{
    p.total=1000; p.buff=0; p.skipTurn=0; p.reverse=0; p.pos=0; p.lost=false; p.finished=false; p.rank=0;
  });
  currentPlayer=0;
  diceCount=1;
  rankCounter=1;
  isExtraRoll = false; 
  rollBtn.disabled = false; eventBtn.disabled = true; 
  economyMode = 'normal'; updateEconomyDisplay(); 
  winnerModal.style.display='none';
  diceSumEl.textContent = 'åˆè¨ˆ: 0'; // === è¿½åŠ  ===
  updateUI();
});

function clearDice(){diceAreaEl.innerHTML='';}
// ä¿®æ­£: showDiceRollé–¢æ•°ã§åˆè¨ˆå€¤ã‚’è¿”ã™ã‚ˆã†ã«å¤‰æ›´
function showDiceRoll(n){
  clearDice();
  let actualN = n;
  if(economyMode === 'burst') actualN = Math.max(1, actualN - 1);
  if(economyMode === 'ice') actualN = Math.max(1, actualN - 1);
  if(economyMode === 'wind') actualN += 1;
  
  let totalVal = 0; // åˆè¨ˆå€¤å¤‰æ•°

  for(let i=0;i<actualN;i++){
    const num=Math.floor(Math.random()*6)+1;
    totalVal += num; // åŠ ç®—
    const img=document.createElement('img');
    img.src=`./dice${num}.png`;
    img.alt=`dice ${num}`;
    img.style.transform='translateY(-14px) rotate(-18deg) scale(0.92)';
    diceAreaEl.appendChild(img);
    ((el,delay)=>{setTimeout(()=>{el.style.transition='transform .45s cubic-bezier(.2,.8,.2,1)'; el.style.transform='translateY(0) rotate(0) scale(1)';}, delay);})(img,i*90);
  }
  if(economyMode === 'burst' && n > actualN) showEventCard("ãƒãƒ–ãƒ«å´©å£Šä¸­ï¼ã‚µã‚¤ã‚³ãƒ­ãŒæ¸›ã‚Šã¾ã—ãŸï¼");
  
  diceSumEl.textContent = 'åˆè¨ˆ: ' + totalVal; // === åˆè¨ˆå€¤ã‚’ç”»é¢ã«è¡¨ç¤º ===
  
  return totalVal; // åˆè¨ˆå€¤ã‚’è¿”ã™
}

function showEventCard(text){
  eventLabel.textContent='ã‚¤ãƒ™ãƒ³ãƒˆ';
  eventText.textContent=text;
  eventCard.classList.remove('hidden');
  clearTimeout(eventCard._timeout);
  eventCard._timeout=setTimeout(()=>eventCard.classList.add('hidden'),4000);
}

function applyEventEffect(text, p) {
  saveState();

  // å®ãã˜ã¨ã‚¯ã‚¤ã‚ºã¯ç‰¹æ®Šãªé–¢æ•°ã¸é£›ã°ã™
  if (text === "å®ãã˜") {
    startLottery(p);
    return;
  }
  if (text === "ã‚¯ã‚¤ã‚ºï¼") {
    startQuiz(p);
    return;
  }

  // ç‰¹æ®ŠåŠ¹æœã®å‡¦ç†
  if (text.includes('æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‚µã‚¤ã‚³ãƒ­1ã¤è¿½åŠ ')) players[p].buff += 1;
  if (text.includes('3ã‚¿ãƒ¼ãƒ³é€†èµ°')) players[p].reverse = 3;
  if (text.includes('æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‚µã‚¤ã‚³ãƒ­3ã¤è¿½åŠ ')) players[p].buff += 3;
  if (text.includes('æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã‚µã‚¤ã‚³ãƒ­2ã¤è¿½åŠ ')) players[p].buff += 2;
  if (text.includes('1ã‚¿ãƒ¼ãƒ³ä¼‘ã¿')) players[p].skipTurn = 1;

  // æ•°å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®é‡‘é¡å‡¦ç†
  const m = text.match(/([0-9]{1,7})/);
  if (m) {
    let num = parseInt(m[1], 10);
    
    // çµŒæ¸ˆçŠ¶æ³ï¼ˆæ™¯æ°—ï¼‰ã«ã‚ˆã‚‹å¤‰å‹•
    if (economyMode === 'inflation') {
      num *= 2;
      text += " (ã‚¤ãƒ³ãƒ•ãƒ¬x2!)";
    } else if (economyMode === 'deflation') {
      num = Math.floor(num / 2);
      text += " (ãƒ‡ãƒ•ãƒ¬/2...)";
    }

    // ãŠé‡‘ã®å¢—æ¸›ã¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«è¡¨ç¤º
    if (text.includes('ç²å¾—')) {
      players[p].total += num;
      spawnMoneyParticle(num); // ç·‘è‰²ã®ãµã‚ã£ã¨ã—ãŸæ•°å­—ã‚’å‡ºã™
    } else if (text.includes('å¤±ã†')) {
      players[p].total -= num;
      spawnMoneyParticle(-num); // èµ¤è‰²ã®ãµã‚ã£ã¨ã—ãŸæ•°å­—ã‚’å‡ºã™
    }
  }

  updateUI();
  showEventCard(`${players[p].name} ã®ã‚¤ãƒ™ãƒ³ãƒˆ: ${text}`);

  // è¿½åŠ è¡Œå‹•ãŒã‚ã‚‹ã‹ã©ã†ã‹ã®åˆ¤å®š
  const isExtraAction = text.includes("åˆ†æˆ»ã‚‹") || text.includes("åˆ†é€²ã‚€") || text.includes("ã‚‚ã†ä¸€å›è¡Œå‹•");
  if (isExtraAction) {
    rollBtn.disabled = false;
    eventBtn.disabled = true;
    isExtraRoll = true;
  } else {
    rollBtn.disabled = true;
    eventBtn.disabled = true;
  }
}

function startQuiz(playerIndex){
  const idx = Math.floor(Math.random() * quizzes.length);
  const quiz = quizzes[idx];
  quizQuestion.textContent = quiz.q;
  quizOptions.innerHTML = '';
  quizResult.textContent = '';
  quizOk.style.display = 'none';
  quizModal.style.display = 'flex';
  
  quiz.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.onclick = () => {
      saveState(); 
      
      // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
      const allBtns = quizOptions.querySelectorAll('button');
      allBtns.forEach(b => b.disabled = true);

      if (i === quiz.answer) {
        // æ­£è§£ã®å‡¦ç†
        players[playerIndex].total += 1200;
        spawnMoneyParticle(1200); // â˜…ç·‘ã®æ•°å­—ã‚’å‡ºã™
        quizResult.textContent = "æ­£è§£ï¼ï¼‹1200ï¼„";
        quizResult.style.color = "#4CAF50";
      } else {
        // ä¸æ­£è§£ã®å‡¦ç†
        players[playerIndex].total -= 500;
        spawnMoneyParticle(-500); // â˜…èµ¤ã®æ•°å­—ã‚’å‡ºã™
        quizResult.textContent = "ä¸æ­£è§£â€¦âˆ’500ï¼„";
        quizResult.style.color = "#f44336";
      }
      
      quizOk.style.display = 'inline-block';
      updateUI();
    };
    quizOptions.appendChild(btn);
  });
}
quizOk.addEventListener('click',()=>{
    quizModal.style.display='none';
    rollBtn.disabled = true;
    eventBtn.disabled = true;
});

eventBtn.disabled = true;

rollBtn.addEventListener('click', () => {
  const player = players[currentPlayer];
  if (player.lost) { showEventCard(`${player.name} ã¯å¤±æ ¼ã®ãŸã‚æŒ¯ã‚Œã¾ã›ã‚“`); return; }
  if (player.finished) { showEventCard(`${player.name} ã¯ã‚´ãƒ¼ãƒ«æ¸ˆã¿ã§ã™`); return; }

  if (player.skipTurn > 0) {
    showEventCard(`${player.name} ã¯ä¼‘ã¿ã®ãŸã‚æŒ¯ã‚Œã¾ã›ã‚“`);
    player.skipTurn--;
    updateUI();
    return;
  }

  saveState();

  const totalDice = diceCount + player.buff;
  const rollResult = showDiceRoll(totalDice); // ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹

  player.buff = 0;
  updateUI();

  // --- ã“ã“ã‹ã‚‰é¸æŠç”»é¢ã®å‡¦ç† ---
  if (rollResult === 6) {
    const modal = document.getElementById('dice-six-modal');
    modal.style.display = 'flex'; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º

    // A.ã€Œã‚‚ã†ä¸€åº¦æŒ¯ã‚‹ã€ã‚’é¸æŠ
    document.getElementById('choice-reroll').onclick = () => {
      modal.style.display = 'none';
      rollBtn.disabled = false; // ãƒœã‚¿ãƒ³ã‚’å†ã³æœ‰åŠ¹åŒ–
      eventBtn.disabled = true;
      isExtraRoll = true;
      showEventCard("è¿½åŠ ã‚¿ãƒ¼ãƒ³ç²å¾—ï¼ã‚‚ã†ä¸€åº¦æŒ¯ã£ã¦ãã ã•ã„ã€‚");
    };

    // B.ã€Œã‚³ãƒã‚’å‡ºã™ã€ã‚’é¸æŠ
    document.getElementById('choice-spawn').onclick = () => {
      modal.style.display = 'none';
      rollBtn.disabled = true;
      eventBtn.disabled = false;
      showEventCard("æ–°ã—ã„ã‚³ãƒã‚’å‡ºåº«ã—ã¾ã—ãŸï¼");
    };
    
    return; // 6ã®æ™‚ã¯ã“ã“ã§çµ‚äº†ï¼ˆä¸‹ã®é€šå¸¸å‡¦ç†ã‚’ã•ã›ãªã„ï¼‰
  }

  // --- 6ä»¥å¤–ã®å ´åˆã®é€šå¸¸å‡¦ç† ---
  showEventCard(`${player.name}ã€åˆè¨ˆ: ${rollResult}ï¼ å‡ºç›®ã®åˆ†é€²ã‚“ã§ãã ã•ã„ï¼`);

  if (isExtraRoll) {
    rollBtn.disabled = true;
    eventBtn.disabled = true;
    isExtraRoll = false;
  } else {
    rollBtn.disabled = true;
    eventBtn.disabled = false;
  }
});

eventBtn.addEventListener('click',()=>{
  const idx=Math.floor(Math.random()*events.length);
  const text=events[idx];
  applyEventEffect(text,currentPlayer);
});

goalBtn.addEventListener('click', ()=>{
  saveState();
  const p = players[currentPlayer];
  p.total += 4000;
  showEventCard(`ğŸš© ${p.name}ã€ã‚³ãƒã‚´ãƒ¼ãƒ«ï¼ +$4000`);
  updateUI();
});

finishBtn.addEventListener('click', ()=>{
  saveState();
  const p = players[currentPlayer];
  if(p.finished) return;
  p.finished = true;
  if(rankCounter <= 4){
    const bonus = rankBonuses[rankCounter];
    p.total += bonus;
    p.rank = rankCounter;
    showEventCard(`ğŸ‘‘ ${p.name}ã€${rankCounter}ä½ã§å…¨ã‚³ãƒã‚´ãƒ¼ãƒ«ï¼ ãƒœãƒ¼ãƒŠã‚¹+$${bonus}`);
    rankCounter++;
  } else {
    p.rank = rankCounter;
    showEventCard(`ğŸ‘‘ ${p.name}ã€å…¨ã‚³ãƒã‚´ãƒ¼ãƒ«ï¼`);
  }
  updateUI();
});


const economyData = {
  normal: {name:"å¹³ç©", bg:"#7bd24a", icon:"â˜€ï¸"},
  inflation: {name:"ã‚¤ãƒ³ãƒ•ãƒ¬ (é‡‘é¡2å€)", bg:"#ffeb3b", icon:"ğŸ“ˆ"},
  deflation: {name:"ãƒ‡ãƒ•ãƒ¬ (é‡‘é¡åŠæ¸›)", bg:"#cfd8dc", icon:"ğŸ“‰"},
  burst: {name:"ãƒãƒ–ãƒ«å´©å£Š (10%æ²¡å)", bg:"#7b1fa2", icon:"ğŸ˜±"}
};

function updateEconomyDisplay(){
  const w = economyData[economyMode];
  const panel = document.getElementById('economy-panel'); // ãƒ‘ãƒãƒ«è¦ç´ ã‚’å–å¾—
  
  document.getElementById('economy-icon').textContent = w.icon;
  document.getElementById('economy-text').textContent = "çµŒæ¸ˆçŠ¶æ³: " + w.name;
  
  // ãƒ‘ãƒãƒ«ã®èƒŒæ™¯è‰²ã ã‘ã‚’æ›¸ãæ›ãˆã‚‹
  panel.style.backgroundColor = w.bg;
}

function checkEconomyChange(){
  if(Math.random() < 0.2){
    const keys = Object.keys(economyData);
    const nextKey = keys[Math.floor(Math.random() * keys.length)];
    economyMode = nextKey;
    updateEconomyDisplay();
    showEventCard(`âš ï¸ çµŒæ¸ˆçŠ¶æ³ãŒã€Œ${economyData[nextKey].name}ã€ã«å¤‰ã‚ã‚Šã¾ã—ãŸï¼`);
  }
}

function endTurn() {
    saveState(); 

    rollBtn.disabled = false;
    eventBtn.disabled = true;
    isExtraRoll = false;
    diceSumEl.textContent = 'åˆè¨ˆ: 0'; // === ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«ãƒªã‚»ãƒƒãƒˆ ===

    if(players[currentPlayer].reverse > 0) players[currentPlayer].reverse--;
    if(economyMode === 'burst' && !players[currentPlayer].lost && players[currentPlayer].total > 0){
       players[currentPlayer].total = Math.floor(players[currentPlayer].total * 0.9);
    }
    proceedToNextPlayer();
}

function proceedToNextPlayer() {
    checkEconomyChange();
    findNextPlayable(1);
}

function findNextPlayable(offset) {
    if(offset > 4) { updateUI(); return; }
    
    let nextIdx = (currentPlayer + offset) % players.length;
    let nextP = players[nextIdx];
    
    if(nextP.lost || nextP.finished) {
       return findNextPlayable(offset + 1);
    }
    
    currentPlayer = nextIdx;
    
    if(nextP.skipTurn > 0) {
       const cost = 300;
       if(nextP.total >= cost) {
          showRecoveryModal(nextP);
          updateUI();
          return;
       } else {
          showEventCard(`${nextP.name} ã¯ä¼‘ã¿ã§ã™ (æ‰€æŒé‡‘ä¸è¶³)`);
          nextP.skipTurn--;
          updateUI();
          rollBtn.disabled = true;
          eventBtn.disabled = true;
          setTimeout(() => { endTurn(); }, 1500);
          return;
       }
    }
    
    updateUI();
    showEventCard(`${nextP.name} ã®ç•ªã§ã™ï¼`);
}

const recModal = document.getElementById('recovery-modal');
const recText = document.getElementById('recovery-text');
const recYes = document.getElementById('rec-yes-btn');
const recNo = document.getElementById('rec-no-btn');

function showRecoveryModal(p) {
   recText.innerHTML = `${p.name}ã•ã‚“ã€ä¸‡èƒ½è–¬($300)ã‚’è³¼å…¥ã—ã¦<br>ä¼‘ã¿çŠ¶æ…‹ã‚’å›å¾©ã—ã¾ã™ã‹ï¼Ÿ`;
   recModal.style.display = 'flex';
}

recYes.onclick = () => {
   saveState();
   const p = players[currentPlayer];
   if(p.total >= 300) {
      p.total -= 300;
      p.skipTurn = 0;
      if(p.reverse > 0) p.reverse = 0; 
      showEventCard(`${p.name} ã¯ä¸‡èƒ½è–¬ã§å›å¾©ã—ã¾ã—ãŸï¼`);
      recModal.style.display = 'none';
      updateUI();
      rollBtn.disabled = false;
   }
};

recNo.onclick = () => {
   saveState();
   const p = players[currentPlayer];
   showEventCard(`${p.name} ã¯å›å¾©ã—ã¾ã›ã‚“ã§ã—ãŸ (1å›ä¼‘ã¿)`);
   p.skipTurn--;
   recModal.style.display = 'none';
   updateUI();
   rollBtn.disabled = true;
   setTimeout(() => { endTurn(); }, 1000);
};


const moneyPanel=document.querySelector('.money-panel');
for(let i=0;i<4;i++){
  const p=players[i];
  const div=document.createElement('div');
  div.className='person-money';
  div.innerHTML=`<div class="color-bar" style="background:${p.color}"></div>
  <div class="info">
  <input class="name-input" id="money-name-${i}" value="${p.name}" />
  <div class="total" id="total-${i}">${p.total}</div>
  <div class="money-buttons">
    <button data-val="-1000">-1000</button>
    <button data-val="-100">-100</button>
    <button data-val="-10">-10</button>
    <button data-val="+10">+10</button>
    <button data-val="+100">+100</button>
    <button data-val="+1000">+1000</button>
  </div>
  </div>`;
  moneyPanel.appendChild(div);

  const buttons = div.querySelectorAll('.money-buttons button');
  buttons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      saveState(); 
      const val = parseInt(btn.getAttribute('data-val'),10);
      p.total += val;
      updateUI();
    });
  });
}

function endTurn() {
  const currentPlayerObj = players[currentPlayer];
  const activePlayers = players.filter(p => !p.lost && !p.finished);
  
  if (activePlayers.length > 0) {
    const lowestPlayer = activePlayers.reduce((prev, curr) => 
      (prev.total < curr.total) ? prev : curr, activePlayers[0]
    );

    // ãƒ†ã‚¹ãƒˆç”¨ã«1.0 (100%)ã€‚æœ¬ç•ªã¯0.03ã«ã€‚
    if (Math.random() < 0.03 && currentPlayerObj === lowestPlayer) {
      saveState();
      
      // --- æ¼”å‡ºï¼šå¤§è¿«åŠ›ã®å¤©ä½¿é™è‡¨ ---
      const bonus = 30000;
      currentPlayerObj.total += bonus;

      // 1. å·¨å¤§ãªå¤©ä½¿ã®ç¾½æ ¹ã‚’èƒŒæ™¯ã«è¡¨ç¤º
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position:fixed; top:0; left:0; width:100%; height:100%;
        background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(255,215,0,0.3) 100%);
        z-index:10000; display:flex; align-items:center; justify-content:center;
        flex-direction:column; animation: fadeInOut 3s forwards; pointer-events:none;
      `;
      overlay.innerHTML = `
        <div style="font-size:120px; filter:drop-shadow(0 0 20px gold); animation: float 1s infinite alternate;">ğŸ‘¼</div>
        <div style="font-size:40px; font-weight:900; color:#d4af37; text-shadow:2px 2px 10px white; margin-top:20px;">
          DIVINE BLESSING!
        </div>
        <div style="font-size:60px; font-weight:900; color:#fff; -webkit-text-stroke:2px gold;">+$${bonus.toLocaleString()}</div>
      `;
      document.body.appendChild(overlay);

      // 2. ç¾½æ ¹ï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼‰ã‚’æ•£ã‚‰ã™
      for(let i=0; i<30; i++) {
        setTimeout(() => {
          const leaf = document.createElement('div');
          leaf.textContent = 'ğŸ•Šï¸';
          leaf.style.cssText = `
            position:fixed; left:${Math.random()*100}%; top:-50px; font-size:${20+Math.random()*30}px;
            z-index:10001; transition: transform 3s linear, top 3s linear; opacity:0.8;
          `;
          document.body.appendChild(leaf);
          setTimeout(() => {
            leaf.style.top = '110%';
            leaf.style.transform = `translateX(${(Math.random()-0.5)*200}px) rotate(${Math.random()*360}deg)`;
          }, 10);
          setTimeout(() => leaf.remove(), 3000);
        }, i * 100);
      }

      // 3. ç”»é¢ã‚’æºã‚‰ã™ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ã‚§ã‚¤ã‚¯ï¼‰
      document.body.style.animation = "shake 0.5s ease-in-out";
      
      showEventCard(`âœ¨ ç¥ã®åŠ è­·ï¼æœ€ä¸‹ä½ã®${currentPlayerObj.name}ã«å¥‡è·¡ãŒèµ·ãã¾ã—ãŸï¼ âœ¨`);

      // 3ç§’å¾Œã«æ¼”å‡ºç”¨è¦ç´ ã‚’å‰Šé™¤
      setTimeout(() => {
        overlay.remove();
        document.body.style.animation = "";
      }, 3000);
    }
  }

  // --- ã‚¿ãƒ¼ãƒ³äº¤ä»£å‡¦ç† ---
  currentPlayer = (currentPlayer + 1) % players.length;
  while (players[currentPlayer].lost || players[currentPlayer].finished) {
    currentPlayer = (currentPlayer + 1) % players.length;
  }
  
  isExtraRoll = false;
  rollBtn.disabled = false;
  eventBtn.disabled = true;
  clearDice();
  if(diceSumEl) diceSumEl.textContent = 'åˆè¨ˆ: 0';
  updateUI();
}

// æ¼”å‡ºç”¨ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³CSSã‚’è¿½åŠ 
const style = document.createElement('style');
style.innerHTML = `
  @keyframes fadeInOut { 0% {opacity:0;} 20% {opacity:1;} 80% {opacity:1;} 100% {opacity:0;} }
  @keyframes float { from {transform:translateY(0) scale(1);} to {transform:translateY(-20px) scale(1.1);} }
  @keyframes shake { 0%, 100% {transform:translateX(0);} 25% {transform:translateX(-10px);} 75% {transform:translateX(10px);} }
`;
document.head.appendChild(style);

endBtn.onclick = endTurn;

// ãƒœã‚¿ãƒ³ã«ã“ã®æ–°ã—ã„ endTurn ã‚’ç™»éŒ²
endBtn.onclick = endTurn;

endBtn.addEventListener('click',endTurn);

const shopBtn = document.getElementById('shopBtn');
const shopModal = document.getElementById('shop-modal');
const shopList = document.getElementById('shop-list');
const shopClose = document.getElementById('shop-close');
const shopTitle = document.getElementById('shop-title');

const items = [
  {name: "ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼", cost: 4000, desc: "æ¬¡ã®ã‚µã‚¤ã‚³ãƒ­ +1", effect: (p) => { p.buff += 1; }},
  {name: "ãƒ­ã‚±ãƒƒãƒˆ", cost: 10000, desc: "æ¬¡ã®ã‚µã‚¤ã‚³ãƒ­ +3", effect: (p) => { p.buff += 3; }},
  {name: "ä¸‡èƒ½è–¬", cost: 3000, desc: "ä¼‘ã¿ãƒ»é€†èµ°ã‚’å›å¾©", effect: (p) => { p.skipTurn = 0; p.reverse = 0; }},
  {name: "å¦¨å®³é›»æ³¢", cost: 6000, desc: "é¸ã‚“ã äººã‚’1å›ä¼‘ã¿ã«ã™ã‚‹", effect: null} ,
  {name: "è‡ªåœ¨ã‚«ãƒ¼ãƒ‰",cost: 15000,desc: "1ã€œ6ã®å¥½ããªæ•°ã ã‘é€²ã‚ã‚‹ã€‚",effect: (p) => {openDiceSelection(p);}},
];

function openShop(){
  const p = players[currentPlayer];
  shopTitle.textContent = "ã‚¢ã‚¤ãƒ†ãƒ ã‚·ãƒ§ãƒƒãƒ—";
  shopList.innerHTML = "";
  shopList.style.display = "grid"; 
  
  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'shop-item';
    const canBuy = p.total >= item.cost;
    
    div.innerHTML = `
      <h3>${item.name}</h3>
      <p>${item.desc}</p>
      <div class="shop-price">$${item.cost}</div>
      <button class="shop-buy-btn" ${canBuy ? '' : 'disabled'}>è³¼å…¥</button>
    `;
    
    div.querySelector('button').addEventListener('click', () => {
      if(p.total >= item.cost){
        if(item.name === "å¦¨å®³é›»æ³¢"){
           // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠãŒå¿…è¦ãªã‚¢ã‚¤ãƒ†ãƒ 
           showTargetSelection(p, item);
           // â€»showTargetSelectionå´ã®ã€Œæ±ºå®šãƒœã‚¿ãƒ³ã€ã«ã‚‚
           // spawnMoneyParticle(-item.cost); ã‚’å…¥ã‚Œã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™
        } else {
           // é€šå¸¸ã‚¢ã‚¤ãƒ†ãƒ ã®è³¼å…¥
           saveState(); 
           p.total -= item.cost;
           
           // â˜…ã“ã“ã§ãŠé‡‘ãŒæ¸›ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼‰ã‚’è¡¨ç¤º
           spawnMoneyParticle(-item.cost); 
           
           item.effect(p);
           showEventCard(`${p.name}ãŒ${item.name}ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼`);
           updateUI();
           shopModal.style.display = 'none';
        }
      }
    });
    
    shopList.appendChild(div);
  });
  shopModal.style.display = 'flex';
}

function showTargetSelection(buyer, item){
  shopTitle.textContent = "èª°ã‚’ä¼‘ã¿ã«ã—ã¾ã™ã‹ï¼Ÿ";
  shopList.innerHTML = "";
  shopList.style.display = "flex";
  shopList.style.flexDirection = "column";

  players.forEach((target, idx) => {
    if(idx !== currentPlayer && !target.lost){
      const btn = document.createElement('button');
      btn.className = 'target-btn';
      btn.textContent = `${target.name} (ç¾åœ¨åœ°:${target.total}$)`;
      btn.onclick = () => {
        saveState(); 
        buyer.total -= item.cost;
        target.skipTurn += 1;
        showEventCard(`${buyer.name}ãŒ${item.name}ã‚’ä½¿ç”¨ï¼${target.name}ã¯1å›ä¼‘ã¿ï¼`);
        updateUI();
        shopModal.style.display = 'none';
      };
      shopList.appendChild(btn);
    }
  });

  const backBtn = document.createElement('button');
  backBtn.textContent = "æˆ»ã‚‹";
  backBtn.style.marginTop = "10px";
  backBtn.onclick = openShop; 
  shopList.appendChild(backBtn);
}

shopBtn.addEventListener('click', openShop);
shopClose.addEventListener('click', () => { shopModal.style.display = 'none'; });

updateUI();
// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®å®Ÿè£…
document.addEventListener('keydown', (event) => {
  // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹æ™‚ã¯ç„¡åŠ¹
  if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;

  const key = event.key.toLowerCase();
  const isShift = event.shiftKey;

  // Shift + S : ã‚·ãƒ§ãƒƒãƒ—
  if (isShift && key === 's') {
    event.preventDefault();
    if (!shopBtn.disabled) shopBtn.click();
    return;
  }

  // S : ã‚µã‚¤ã‚³ãƒ­
  if (key === 's' && !isShift) {
    if (!rollBtn.disabled) rollBtn.click();
  }

  // E : ã‚¤ãƒ™ãƒ³ãƒˆ
  if (key === 'e') {
    if (!eventBtn.disabled) eventBtn.click();
  }

  // N : ã‚¿ãƒ¼ãƒ³çµ‚äº† (ã“ã“ã‚’ä¿®æ­£)
  if (key === 'n') {
    if (!endBtn.disabled) {
      event.preventDefault(); // ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨™æº–æŒ™å‹•ã‚’æ­¢ã‚ã‚‹
      
      // é‡è¦ï¼šãƒœã‚¿ãƒ³ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¼·åˆ¶è§£é™¤ï¼ˆäºŒé‡å®Ÿè¡Œã‚’é˜²æ­¢ï¼‰
      endBtn.blur(); 
      
      // ç›´æ¥é–¢æ•°ã‚’å‘¼ã¶
      endTurn(); 
    }
  }
});
</script>
</body>
</html>